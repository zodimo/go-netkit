# Story 1.2: Middleware and Handler Ecosystem Transformation

<!-- Powered by BMADâ„¢ Core -->

## Status
Draft

## Story
**As a** middleware developer,  
**I want** all middleware implementations and handler utilities to use cbio callback-style interfaces,  
**so that** the middleware chain provides consistent asynchronous I/O handling across all transport operations.

## Acceptance Criteria

**AC1**: MiddlewareMux.OnOpen method signature updated to accept cbio.WriteCloser

**AC2**: Logger middleware in middlewares/logger.go uses cbio interfaces for all I/O operations

**AC3**: All test utilities in test_utils.go implement cbio interfaces instead of standard I/O

**AC4**: recordingTransportHandler uses cbio.WriteCloser for connection handling

## Tasks / Subtasks

- [ ] Update MiddlewareMux interface (AC: 1)
  - [ ] Change OnOpen method signature to accept cbio.WriteCloser
  - [ ] Update interface documentation
  - [ ] Verify middleware chaining compatibility
  - [ ] Update all MiddlewareMux implementations

- [ ] Refactor Logger middleware (AC: 2)
  - [ ] Update logger.go to import cbio package
  - [ ] Convert all I/O operations to callback patterns
  - [ ] Implement callback success and error handlers for logging
  - [ ] Test logging middleware with callback operations

- [ ] Convert test utilities (AC: 3)
  - [ ] Update test_utils.go imports to use cbio
  - [ ] Verify test utility compatibility across test suite

- [ ] Update recordingTransportHandler (AC: 4)
  - [ ] Change connection parameter to cbio.WriteCloser
  - [ ] Update recording logic for callback operations
  - [ ] Implement callback handlers for recording
  - [ ] Test recording functionality with callbacks

- [ ] Unit testing
  - [ ] Update middleware_test.go to use cbio interfaces
  - [ ] Test middleware chaining with callback operations
  - [ ] Test error propagation through middleware chain
  - [ ] Test cancellation behavior in middleware
  - [ ] Verify all existing middleware tests pass

## Dev Notes

### Previous Story Insights
This story depends on Story 1.1 completion, which provides the foundation cbio interfaces in the transport layer.

### Architecture Context
The middleware system must maintain its chaining behavior while transitioning to callback-style operations:
- `MiddlewareMux` coordinates multiple middleware instances
- Each middleware must handle callback success and error scenarios
- Logger middleware needs to capture callback operation results
- Test utilities must provide realistic callback behavior for testing

### Technical Implementation Details
- Middleware chaining must preserve callback context through the chain
- Error handling in middleware should not break the callback chain
- Logging middleware should capture both immediate and callback errors
- Mock implementations must simulate realistic callback timing and behavior
- Cancellation signals should propagate through the middleware chain

### File Locations
Primary files to modify:
- `middleware.go` - Core middleware interfaces and implementations
- `middlewares/logger.go` - Logger middleware implementation
- `test_utils.go` - Test utilities and mock implementations
- `middleware_test.go` - Unit tests for middleware functionality

### Testing Requirements
- Middleware chaining behavior must remain identical with callback interfaces
- All middleware tests must pass without functionality regression
- Mock implementations must provide accurate callback behavior for testing scenarios
- Performance impact of callback overhead should be minimal

### Testing
- Test file location: Same directory as source files with `_test.go` suffix
- Test standards: Use Go's built-in testing framework with comprehensive middleware chain testing
- Testing frameworks: Standard Go testing with mock implementations for callback verification
- Middleware tests should verify both success and error callback scenarios

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2024-01-XX | 1.0 | Initial story creation from epic | BMad Master |

## Dev Agent Record

*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results
*Results from QA Agent review will be populated here*
